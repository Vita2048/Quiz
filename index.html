<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Czech Cities Quiz ‚Äî 30 Questions</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --accent:#22c1c3;
    --muted:#9aa4b2;
    --glass: rgba(255,255,255,0.03);
  }
  body{
    margin:0;
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: linear-gradient(180deg,#071024 0%, #071824 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .wrap{
    width:100%;
    max-width:1200px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    overflow:hidden;
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:20px;
    padding:20px;
  }

  /* Responsive: stack on small screens */
  @media (max-width:980px){
    .wrap { grid-template-columns: 1fr; padding:12px; }
    .right { order:2; }
    .left { order:1; }
  }

  .left{
    background:var(--glass);
    border-radius:12px;
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:stretch;
  }
  .map-holder{
    background:linear-gradient(180deg, rgba(0,0,0,0.2), rgba(255,255,255,0.02));
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:420px;
  }
  svg#czMap path {
  stroke: #cccccc !important;
  stroke-width: 0.8 !important;
  fill: #0b1220; /* keep background dark */
}


.flash-dot {
  animation: flash 1s infinite;
}

@keyframes flash {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}


  .right{
    background:var(--card);
    border-radius:12px;
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .progress {
    display:flex;
    align-items:center;
    gap:12px;
    justify-content:space-between;
  }
  .progress .bar {
    flex:1;
    height:12px;
    background:rgba(255,255,255,0.05);
    border-radius:8px;
    overflow:hidden;
    margin-left:12px;
  }
  .progress .bar > i {
    height:100%;
    display:block;
    width:0%;
    background:linear-gradient(90deg, #22c1c3, #3b82f6);
    border-radius:8px;
    transition:width 400ms ease;
  }
  h1{
    margin:0;
    font-size:18px;
    letter-spacing:0.2px;
  }
  .meta{
    color:var(--muted);
    font-size:13px;
  }

  .choices{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:6px;
  }
  .choice{
    background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));
    border-radius:10px;
    padding:10px 12px;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    border:1px solid rgba(255,255,255,0.03);
    transition: transform 120ms ease, box-shadow 120ms ease;
    user-select:none;
  }
  .choice:hover{ transform:translateY(-4px); box-shadow: 0 8px 18px rgba(2,6,23,0.5); }
  .choice.selected{ outline:2px solid rgba(34,193,195,0.18); box-shadow: 0 10px 22px rgba(34,193,195,0.06); }
.choice.correct {
  border: 2px solid #22c55e; /* bright green */
  background: #14532d;
  color: #d1fae5;
}
.choice.wrong {
  border: 2px solid #ef4444; /* bright red */
  background: #7f1d1d;
  color: #fee2e2;
}

  .controls{
    display:flex;
    gap:10px;
    margin-top:8px;
    justify-content:flex-end;
  }
  button.btn{
    background:linear-gradient(180deg,#1f8b8b,#197a7a);
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
  }
  button.btn.secondary{
    background:transparent;
    border:1px solid rgba(255,255,255,0.06);
    color:var(--muted);
    font-weight:600;
  }

  .summary{
    padding:12px;
    border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));
    font-size:14px;
  }
  .summary h2{ margin:0 0 6px 0; font-size:16px; }
  .summary .bigscore{
    display:flex;
    gap:18px;
    align-items:center;
    margin-bottom:8px;
  }
  .summary .bigscore .score{
    font-size:28px;
    font-weight:700;
    color:#dbeefe;
  }
  .breakdown{
    margin-top:12px;
    overflow:auto;
    max-height:380px;
    border-radius:8px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  th,td{
    padding:8px 6px;
    text-align:left;
    border-bottom:1px dashed rgba(255,255,255,0.04);
  }
  th{ color:var(--muted); font-weight:600; font-size:12px; }
  tr.correct td{ background: rgba(34,193,195,0.02); }
  tr.wrong td{ background: rgba(255,80,80,0.02); }

  .footer{
    font-size:12px;
    color:var(--muted);
    text-align:center;
    margin-top:10px;
  }

  /* small helper */
  .center { display:flex; align-items:center; justify-content:center; }
  .hint { color:var(--muted); font-size:13px; }
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="Czech Cities Quiz">
  <div class="left">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <h1>Czech Cities Quiz</h1>
        <div class="meta">Find the city shown by the flashing dot. 30 random cities per session.</div>
      </div>
      <div id="top-actions" style="text-align:right">
        <div class="meta" id="progressText">Question 0/30</div>
        <div style="height:6px"></div>
        <div class="progress" style="width:260px;">
          <div style="font-size:12px;color:var(--muted);width:110px">Progress</div>
          <div class="bar" aria-hidden="true"><i id="progressBar"></i></div>
        </div>
      </div>
    </div>

    <div class="map-holder" aria-hidden="false">
      <div id="mapContainer" style="width:100%;max-width:900px;">
        <!-- SVG map will be injected here -->
        <div id="mapLoader" class="center" style="padding:34px;">
          <div style="text-align:center">
            <div class="hint">Loading map and cities...</div>
            <div style="margin-top:10px"><small class="meta">If nothing loads, check CORS or network access to the two files.</small></div>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
      <div class="hint">Tip: distractors are chosen from nearby cities for a plausible challenge.</div>
      <div id="controlsSmall"></div>
    </div>
  </div>

  <div class="right">
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-size:13px;color:var(--muted)">Question</div>
          <div style="font-size:18px;font-weight:700" id="questionTitle">‚Äî</div>
        </div>
        <div style="text-align:right">
          <div class="meta">Score</div>
          <div style="font-size:18px;font-weight:700" id="scoreDisplay">0</div>
        </div>
      </div>

      <div class="choices" id="choices"></div>

      <div class="controls">
        <button class="btn secondary" id="btnRestart">Restart</button>
        <button class="btn" id="btnNext" disabled>Next</button>
      </div>
    </div>

    <div class="summary" id="summaryPanel" style="display:none;">
      <h2>Quiz summary</h2>
      <div class="bigscore">
        <div class="score" id="finalScore">0 / 30</div>
        <div>
          <div class="meta">Percentage</div>
          <div style="font-size:20px;font-weight:700" id="finalPct">0%</div>
        </div>
      </div>

      <div class="breakdown" id="breakdown"></div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn secondary" id="btnExport">Export CSV</button>
        <button class="btn" id="btnPlayAgain">Play Again</button>
      </div>
    </div>

  </div>
</div>

<script>

/*
  Czech Cities Quiz ‚Äî fixed CSV parser
*/
const SVG_URL = 'https://vita2048.github.io/Quiz/cz.svg';
const CSV_URL = 'https://vita2048.github.io/Quiz/cz.csv';
const TOTAL_QUESTIONS = 30;
const CZECH_BBOX = { minLat:48.55, maxLat:51.06, minLon:12.09, maxLon:18.87 };

function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a;}
function toLatLon(text){
  if(!text) return null;
  const parts = text.replace(/,/g,';').split(';').map(x=>x.trim()).filter(Boolean);
  if(parts.length<2) return null;
  const lat=parseFloat(parts[0]), lon=parseFloat(parts[1]);
  if(isFinite(lat)&&isFinite(lon)) return {lat,lon};
  return null;
}

// --- üß© updated parser handles semicolon or comma separated files gracefully
function parseCSVsmart(txt){
  const lines = txt.trim().split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  // auto-detect delimiter
  const delim = (lines[0].includes(';') && !lines[0].includes(',')) ? ';' : ',';
  const headers = lines[0].split(delim).map(h=>h.trim());
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(delim).map(c=>c.trim());
    const o={};
    for(let j=0;j<headers.length;j++) o[headers[j]]=cols[j]||'';
    rows.push(o);
  }
  return rows;
}

function hav(a,b){
  const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lon-a.lon)*Math.PI/180;
  const la=a.lat*Math.PI/180, lb=b.lat*Math.PI/180;
  const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
  const A=s1*s1+Math.cos(la)*Math.cos(lb)*s2*s2;
  return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
}

let cities=[],quizCities=[],currentIndex=0,score=0,answers=[],svgElement=null,svgViewBox={x:0,y:0,width:800,height:600};
const mapContainer=document.getElementById('mapContainer'),
      mapLoader=document.getElementById('mapLoader'),
      progressText=document.getElementById('progressText'),
      progressBar=document.getElementById('progressBar'),
      questionTitle=document.getElementById('questionTitle'),
      choicesDiv=document.getElementById('choices'),
      scoreDisplay=document.getElementById('scoreDisplay'),
      btnNext=document.getElementById('btnNext'),
      btnRestart=document.getElementById('btnRestart'),
      summaryPanel=document.getElementById('summaryPanel'),
      finalScore=document.getElementById('finalScore'),
      finalPct=document.getElementById('finalPct'),
      breakdown=document.getElementById('breakdown'),
      btnPlayAgain=document.getElementById('btnPlayAgain'),
      btnExport=document.getElementById('btnExport');

async function init(){
  try{
    const [csvRes,svgRes]=await Promise.all([fetch(CSV_URL),fetch(SVG_URL)]);
    const csvTxt=await csvRes.text(), svgTxt=await svgRes.text();
    const parsed=parseCSVsmart(csvTxt);

    // --- identify columns flexibly ---
cities = parsed.map(r => {
  const name = r.city || r.City || r['City Name'] || r['name'] || r['NAME'] || r['Mƒõsto'];

  let lat = null, lon = null;

  // try coordinate pairs first
  const combo = r['lat;lng'] || r['lat;lon'] || r['lat,lng'] || r['latlon'] || r['coords'] || '';
  const pair = toLatLon(combo);
  if (pair) {
    lat = pair.lat;
    lon = pair.lon;
  } else {
    const la = parseNumber(r.lat || r.Lat || r.latitude || r.Latitude);
    const lo = parseNumber(r.lng || r.lon || r.Lon || r.Longitude || r.longitude);
    if (isFinite(la) && isFinite(lo)) {
      lat = la;
      lon = lo;
    }
  }

  return { name, lat, lon };
}).filter(c => c.name && isFinite(c.lat) && isFinite(c.lon));
function parseNumber(val) {
  if (!val) return NaN;
  return parseFloat(val.replace(',', '.'));
}

    if(!cities.length) throw new Error('No valid cities parsed from CSV.');

    // --- inject SVG ---
    mapContainer.innerHTML=svgTxt;
    svgElement=mapContainer.querySelector('svg');
	// after svgElement is set

    if(!svgElement) throw new Error('SVG missing root <svg>.');
    const vb=svgElement.getAttribute('viewBox');
    if(vb){
      const p=vb.split(/\s+|,/).map(Number).filter(n=>!isNaN(n));
      if(p.length===4) svgViewBox={x:p[0],y:p[1],width:p[2],height:p[3]};
    }else{
      svgElement.setAttribute('viewBox','0 0 800 600');
    }
    svgElement.setAttribute('id','czMap');
svgElement.querySelectorAll('path').forEach(p=>{
  p.setAttribute('stroke','#cccccc');
  p.setAttribute('stroke-width','0.8');
});
    shuffle(cities);
    quizCities=cities.slice(0,TOTAL_QUESTIONS);
    answers=quizCities.map(c=>({city:c,correct:c.name,chosen:null,options:[]}));
    mapLoader.style.display='none';
    currentIndex=0; score=0; scoreDisplay.textContent=score;
    updateProgress(); renderQuestion();
  }catch(e){
    mapLoader.innerHTML=`<div style="color:#f99">${e.message}</div>`;
    console.error(e);
  }
}

function updateProgress(){
  progressText.textContent=`Question ${Math.min(currentIndex+1,TOTAL_QUESTIONS)}/${TOTAL_QUESTIONS}`;
  progressBar.style.width=Math.round((currentIndex/TOTAL_QUESTIONS)*100)+'%';
  questionTitle.textContent='Which city is this?';
}

function mapLatLonToSvg(lat, lon) {
  const { minLat, maxLat, minLon, maxLon } = CZECH_BBOX;
  const { x, y, width, height } = svgViewBox;

  // Basic linear projection from lat/lon to SVG coords
  let fx = (lon - minLon) / (maxLon - minLon);
  let fy = (lat - minLat) / (maxLat - minLat);
  let cx = x + Math.min(Math.max(fx, 0), 1) * width;
  let cy = y + (1 - Math.min(Math.max(fy, 0), 1)) * height;

  // Light ‚Äúkeep-inside‚Äù correction using outline‚Äôs bounding box
  const path = svgElement?.querySelector('path');
  if (path) {
    const bb = path.getBBox();
    // add small padding to ensure visibility inside the border
    const pad = 5;
    cx = Math.min(Math.max(cx, bb.x + pad), bb.x + bb.width - pad);
    cy = Math.min(Math.max(cy, bb.y + pad), bb.y + bb.height - pad);
  }

  return { x: cx, y: cy };
}




function renderDotForCity(city){
  if(!svgElement) return;
  const ns='http://www.w3.org/2000/svg';
  let g=svgElement.querySelector('#dotGroup');
  if(!g){g=document.createElementNS(ns,'g');g.id='dotGroup';svgElement.appendChild(g);}
  while(g.firstChild) g.removeChild(g.firstChild);
  const p=mapLatLonToSvg(city.lat,city.lon);
  const c=document.createElementNS(ns,'circle');
  c.setAttribute('cx',p.x); c.setAttribute('cy',p.y);
  c.setAttribute('r',8); c.setAttribute('fill','red');
  c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','1.5');
  c.setAttribute('class','flash-dot'); g.appendChild(c);
}

function buildOptionsForIndex(i){
  const main=quizCities[i];
  const others=cities.filter(c=>c.name!==main.name)
    .map(o=>({name:o.name,d: hav({lat:main.lat,lon:main.lon},{lat:o.lat,lon:o.lon})}))
    .sort((a,b)=>a.d-b.d)
    .slice(0,3).map(o=>o.name);
  const opts=shuffle([main.name,...others]);
  answers[i].options=opts; return opts;
}

function clearExtraAnnotations() {
  if (!svgElement) return;
  const g = svgElement.querySelector('#extraGroup');
  if (g) g.innerHTML = '';
}


function renderQuestion(){
clearExtraAnnotations();
  if(currentIndex>=quizCities.length){finishQuiz();return;}
  btnNext.disabled=true; choicesDiv.innerHTML='';
  const c=quizCities[currentIndex]; renderDotForCity(c);
  const opts=buildOptionsForIndex(currentIndex);
  opts.forEach((o,i)=>{
    const d=document.createElement('div');
    d.className='choice'; d.textContent=o; d.tabIndex=0;
    d.onclick=()=>selectChoice(d); d.onkeypress=(e)=>{if(e.key==='Enter')selectChoice(d)};
    choicesDiv.appendChild(d);
  });
  scoreDisplay.textContent=score;
}

function renderExtraDotsAndLabels(mainCity, options, correctName) {
  if (!svgElement) return;
  const ns = 'http://www.w3.org/2000/svg';
  let g = svgElement.querySelector('#extraGroup');
  if (!g) {
    g = document.createElementNS(ns, 'g');
    g.id = 'extraGroup';
    svgElement.appendChild(g);
  }
  while (g.firstChild) g.removeChild(g.firstChild);

  // Collect all cities to show: correct + distractors
  const showCities = options.map(name => cities.find(c => c.name === name)).filter(Boolean);

  // Track used label positions to avoid overlap
  const usedPositions = [];

  showCities.forEach((city, idx) => {
    const p = mapLatLonToSvg(city.lat, city.lon);

    // Dot
    const c = document.createElementNS(ns, 'circle');
    c.setAttribute('cx', p.x);
    c.setAttribute('cy', p.y);
    c.setAttribute('r', city.name === correctName ? 8 : 5);
    c.setAttribute('fill', city.name === correctName ? 'limegreen' : 'red');
    c.setAttribute('stroke', '#fff');
    c.setAttribute('stroke-width', '1');
    g.appendChild(c);

    // Label position offset
    let lx = p.x + 15;
    let ly = p.y - 10;

    // Adjust to avoid overlap with previous labels
    let tries = 0;
    while (usedPositions.some(pos => Math.abs(pos.x - lx) < 40 && Math.abs(pos.y - ly) < 16) && tries < 10) {
      ly += 16; // push label down
      tries++;
    }
    usedPositions.push({ x: lx, y: ly });

    // Line
    const line = document.createElementNS(ns, 'line');
    line.setAttribute('x1', p.x);
    line.setAttribute('y1', p.y);
    line.setAttribute('x2', lx);
    line.setAttribute('y2', ly - 4);
    line.setAttribute('stroke', '#ccc');
    line.setAttribute('stroke-width', '1');
    g.appendChild(line);

    // Label
    const text = document.createElementNS(ns, 'text');
    text.setAttribute('x', lx);
    text.setAttribute('y', ly);
    text.setAttribute('fill', '#fff');
    text.setAttribute('font-size', '12px');
    text.setAttribute('font-family', 'sans-serif');
    text.textContent = city.name;
    g.appendChild(text);
  });
}


function selectChoice(el){
  // clear previous selection
  document.querySelectorAll('.choice').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  btnNext.disabled=false;

  const chosen = el.textContent;
  const correct = answers[currentIndex].correct;
  answers[currentIndex].chosen = chosen;

  // mark immediately
  document.querySelectorAll('.choice').forEach(c=>{
    if(c.textContent===correct) c.classList.add('correct');
    if(c.textContent===chosen && chosen!==correct) c.classList.add('wrong');
    c.style.pointerEvents='none';
  });

  if(chosen===correct) score++;
  scoreDisplay.textContent=score;
  
  if (chosen !== correct) {
  // Show all distractors + correct city with labels
  renderExtraDotsAndLabels(quizCities[currentIndex], answers[currentIndex].options, correct);
  }
}


btnNext.onclick=()=>{
  currentIndex++;
  renderQuestion();
  updateProgress();
};


btnRestart.onclick=()=>location.reload();

function finishQuiz(){
  summaryPanel.style.display='block';
  finalScore.textContent=`${score}/${TOTAL_QUESTIONS}`;
  finalPct.textContent=Math.round(score/TOTAL_QUESTIONS*100)+'%';
  const rows=answers.map((a,i)=>`
    <tr class="${a.chosen===a.correct?'correct':'wrong'}">
      <td>${i+1}</td><td>${a.city.name}</td>
      <td>${a.chosen||''}</td><td>${a.correct}</td>
      <td>${a.chosen===a.correct?'‚úÖ':'‚ùå'}</td></tr>`).join('');
  breakdown.innerHTML=`<table><thead><tr><th>#</th><th>City</th><th>Your</th><th>Correct</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
}
btnPlayAgain.onclick=()=>location.reload();
btnExport.onclick=()=>{
  const h=['Q','City','Your','Correct','Result'];
  const r=answers.map((a,i)=>[i+1,a.city.name,a.chosen,a.correct,a.chosen===a.correct?'Correct':'Wrong']);
  const csv=[h.join(','),...r.map(x=>x.join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='results.csv'; a.click(); URL.revokeObjectURL(url);
};
init();

</script>
</body>
</html>
